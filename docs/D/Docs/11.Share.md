看板达到可用状态TODO 
  [x] 登录成功率iOS海外也需要加个版本限制1.9.1
暂时无法在飞书文档外展示此内容
暂时无法在飞书文档外展示此内容
  [x] 新户启动时间 老户启动时间 lcp时间需要过滤>0 <10s的数
暂时无法在飞书文档外展示此内容
暂时无法在飞书文档外展示此内容
暂时无法在飞书文档外展示此内容
暂时无法在飞书文档外展示此内容
暂时无法在飞书文档外展示此内容
暂时无法在飞书文档外展示此内容
暂时无法在飞书文档外展示此内容

周维度表参考 dws_inspo.dws_inspo_base_experience_metrics_weekly的形式
1、hailuo_dw.dws_hailuovedio_meerkat_function_core_di
WITH base AS 
(
    SELECT  CASE    WHEN GET_JSON_OBJECT(properties,'$.client') = 'App' THEN 'App'
                    WHEN GET_JSON_OBJECT(properties,'$.client') IN ('video-web','web') THEN 'web'
                    WHEN GET_JSON_OBJECT(properties,'$.client') IN ('video-h5','h5') THEN 'h5'
                    ELSE 'OTHER'
            END AS client
            ,lib
            ,NVL(NVL(GET_JSON_OBJECT(properties,'$.os'),GET_JSON_OBJECT(properties,'$.$os')),'') AS os
            ,BIGINT(NVL(GET_JSON_OBJECT(properties,'$.login_status'),'0')) AS login_status 
            ,GET_JSON_OBJECT(properties, '$.$app_version') AS app_version
            ,hailuo_ods.HandleInspoVersionCode(get_json_object(properties, '$.$app_version')) AS std_app_version
            ,GET_JSON_OBJECT(properties,'$.popup_type') AS popup_type
            ,GET_JSON_OBJECT(properties,'$.result_type') AS result_type
            ,GET_JSON_OBJECT(properties,'$.login_type') AS login_type
            ,GET_JSON_OBJECT(properties,'$.fail_reason') AS fail_reason
            ,GET_JSON_OBJECT(properties,'$.error_code') AS error_code
            ,GET_JSON_OBJECT(properties,'$.status') AS `status`
            ,GET_JSON_OBJECT(properties,'$.product_type') AS product_type
            ,GET_JSON_OBJECT(properties,'$.entity_type') AS entity_type
            ,GET_JSON_OBJECT(properties,'$.function') AS `function`
            ,GET_JSON_OBJECT(properties,'$.trace_id') AS trace_id
            ,GET_JSON_OBJECT(properties,'$.create_time') AS create_time
            ,GET_JSON_OBJECT(properties,'$.input_trace_id') AS input_trace_id
            ,GET_JSON_OBJECT(properties,'$.result_time') AS result_time --待加
            ,GET_JSON_OBJECT(properties,'$.clk_type') AS clk_type
            ,NVL(GET_JSON_OBJECT(properties,'$.page'),GET_JSON_OBJECT(properties,'$.page_name')) AS page -- get_json_object(properties, '$.duration') AS duration,
            -- get_json_object(properties, '$.image_type') AS `image_type`,
            ,NVL(BIGINT(GET_JSON_OBJECT(properties,'$.hailuo_user_id')),BIGINT(hailuo_ods.HaiLuoUidDecode(NVL(distinct_id,'')))) AS user_id
            ,BIGINT(GET_JSON_OBJECT(properties,'$.device_id')) AS device_id
            ,GET_JSON_OBJECT(properties,'$.login_id') AS login_id
            ,distinct_id
            ,properties
            ,event
            ,ymd
    FROM    talkie_ods.meerkat_event_tracking_rt
    WHERE   ymd = '${ymd}'
    AND     project = 'HailuoVideo'
    AND     distinct_id IS NOT NULL
    AND     GET_JSON_OBJECT(properties,'$.client') IN ('App')
    AND     GET_JSON_OBJECT(properties,'$.$os') IN ('Android','iOS','HarmonyOS')
    AND     event IN ('login_popup_view','login_click','login_result','payment_result','plan_change_click','credit_purchase_popup_pay_click','credit_purchase_pay_click','download_click','download_confirm_click','download_result','upload_image_result','character_detection_result','user_input_track_click','model_output_track_data','image_generate_click','video_generate_click','image_generate_success','video_generate_success','image_generate_fail','video_generate_fail','continue_create_popup_view','continue_create_popup_click')

)
----INSERT OVERWRITE TABLE hailuo_dw.dws_hailuovedio_meerkat_function_core_di PARTITION (ymd = '${ymd}')
SELECT  os
        ,std_app_version
        ,NVL(login_success_cnt / (login_success_cnt + login_fail_cnt),0.0) AS login_success_rate -- `登录成功率`
        ,NVL(login_cancel_cnt / (login_success_cnt + login_fail_cnt + login_cancel_cnt),0.0) AS login_cancel_rate --`登录取消率`
        ,NVL(subscribe_success_cnt / plan_change_click_cnt,0.0) AS vip_click_buy_suc_rate -- `会员购买点击成功转化率`
        ,NVL(subscribe_success_cnt / (subscribe_success_cnt + subscribe_fail_cnt),0.0) AS vip_buy_suc_rate --`会员购买成功率`
        ,NVL(credit_pay_success_cnt / credit_purchase_pay_click_cnt,0.0) AS credit_purchase_click_suc_rate --`积分购买点击成功转化率`
        ,NVL(credit_pay_success_cnt / (credit_pay_success_cnt + credit_pay_fail_cancel_cnt),0.0) AS credit_purchase_suc_rate --`积分购买成功率`,
        ,NVL(video_download_success_cnt / video_download_confirm_click_cnt,0.0) AS video_download_suc_rate --`视频下载成功率`,
        ,NVL(image_download_success_cnt / image_download_confirm_click_cnt,0.0) AS image_download_suc_rate --`图片下载成功率`,
        ,NVL(upload_image_success_cnt / (upload_image_success_cnt + upload_image_fail_cnt),0.0) AS image_upload_suc_rate --`图片上传成功率`,
        ,NVL(character_detection_success_cnt / (character_detection_success_cnt + character_detection_fail_cnt),0.0) AS character_detection_suc_rate --`主体检测成功率`,
        ,login_popup_view_cnt
        ,login_click_cnt
        ,login_success_cnt
        ,login_fail_cnt
        ,login_cancel_cnt
        ,plan_change_click_cnt
        ,subscribe_success_cnt
        ,subscribe_fail_cnt
        ,subscribe_cancel_cnt
        ,credit_purchase_pay_click_cnt
        ,credit_pay_success_cnt
        ,credit_pay_fail_cancel_cnt
        ,video_download_confirm_click_cnt
        ,video_download_success_cnt
        ,image_download_confirm_click_cnt
        ,image_download_success_cnt
        ,upload_image_success_cnt
        ,upload_image_fail_cnt
        ,upload_image_subject_cnt
        ,character_detection_success_cnt
        ,character_detection_fail_cnt
        ,NVL(image_generate_success_cnt / image_generate_click_cnt,0) AS `图像生成成功率`
        ,NVL(video_generate_success_cnt / video_generate_click_cnt,0) AS `视频生成成功率`
        ,NVL(continue_create_cnt / continue_create_popup_view_cnt,0) AS `使用草稿率`
        ,NVL(continue_recreate_cnt / continue_create_popup_view_cnt,0) AS `草稿重新生成率`
        ,image_generate_click_cnt
        ,video_generate_click_cnt
        ,image_generate_success_cnt
        ,video_generate_success_cnt 
        ----SUM(IF(event IN ('image_generate_fail'),1,0)) as image_generate_fail_cnt,
        ----SUM(IF(event IN ('video_generate_fail'),1,0)) as video_generate_fail_cnt,
        ,continue_create_popup_view_cnt
        ,continue_create_cnt
        ,continue_recreate_cnt
FROM    (
            SELECT  os
                    ,IF(GROUPING(std_app_version) = 1,'ALL',std_app_version) AS std_app_version
                    ,SUM(IF(event IN ('login_popup_view'),1,0)) AS login_popup_view_cnt
                    ,SUM(IF(event IN ('login_click'),1,0)) AS login_click_cnt
                    ,SUM(IF(event IN ('login_result') AND result_type = 1 ,1,0)) AS login_success_cnt
                    ,SUM(IF(event IN ('login_result') AND result_type IN (0,2) AND fail_reason NOT IN ('3','cancel','cancle'),1,0)) AS login_fail_cnt
                    ,SUM(
                        IF(event IN ('login_result') AND result_type IN (0,2) AND fail_reason IN ('3','cancel','cancle'),1,0)
                    ) AS login_cancel_cnt
                    ,SUM(IF(event IN ('plan_change_click'),1,0)) AS plan_change_click_cnt
                    ,SUM(IF(event IN ('payment_result') AND status = 0 AND product_type = 'subscription',1,0)) AS subscribe_success_cnt
                    ,SUM(IF(event IN ('payment_result') AND status IN (1) AND product_type = 'subscription' AND error_code NOT IN (999,2,3,6,7,12),1,0)) as subscribe_fail_cnt
                    ,SUM(IF(event IN ('payment_result') AND status IN (2) AND product_type = 'subscription',1,0)) as subscribe_cancel_cnt
                    ,SUM(IF(event IN ('credit_purchase_popup_pay_click','credit_purchase_pay_click'),1,0)) AS credit_purchase_pay_click_cnt
                    ,SUM(IF(event IN ('payment_result') AND status = 0 AND product_type = 'credit',1,0)) as credit_pay_success_cnt
                    ,SUM(IF(event IN ('payment_result') AND status IN (1) AND product_type = 'credit' AND error_code NOT IN (999,2,3,6,7,12),1,0)) as credit_pay_fail_cancel_cnt

                    ,SUM(IF(event IN ('download_confirm_click') AND entity_type = 'video',1,0)) AS video_download_confirm_click_cnt
                    ,SUM(IF(event IN ('download_result') AND result_type = 1 AND entity_type = 'video',1,0)) AS video_download_success_cnt
                    ,SUM(IF(event IN ('download_confirm_click') AND entity_type = 'image',1,0)) AS image_download_confirm_click_cnt
                    ,SUM(IF(event IN ('download_result') AND result_type = 1 AND entity_type = 'image',1,0)) AS image_download_success_cnt
                    ,SUM(IF(event IN ('upload_image_result') AND result_type = 1,1,0)) AS upload_image_success_cnt
                    ,SUM(IF(event IN ('upload_image_result') AND result_type = 0,1,0)) AS upload_image_fail_cnt
                    ,SUM(
                        IF(event IN ('upload_image_result') AND result_type = 1 AND `function` IN ('s2v','a2i'),1,0)
                    ) AS upload_image_subject_cnt
                    ,SUM(
                        IF(event IN ('character_detection_result') AND result_type = 1 AND `function` IN ('s2v','a2i'),1,0)
                    ) AS character_detection_success_cnt
                    ,SUM(
                        IF(event IN ('character_detection_result') AND result_type IN (0,2) AND `function` IN ('s2v','a2i'),1,0)
                    ) AS character_detection_fail_cnt

                    ,SUM(IF(event IN ('image_generate_click'),1,0)) AS image_generate_click_cnt
                    ,SUM(IF(event IN ('video_generate_click'),1,0)) AS video_generate_click_cnt
                    ,SUM(IF(event IN ('image_generate_success'),1,0)) AS image_generate_success_cnt
                    ,SUM(IF(event IN ('video_generate_success'),1,0)) AS video_generate_success_cnt ----SUM(IF(event IN ('image_generate_fail'),1,0)) as image_generate_fail_cnt,
                    ----SUM(IF(event IN ('video_generate_fail'),1,0)) as video_generate_fail_cnt,
                    ,SUM(IF(event IN ('continue_create_popup_view'),1,0)) AS continue_create_popup_view_cnt
                    ,SUM(IF(event IN ('continue_create_popup_click') AND clk_type = 1,1,0)) AS continue_create_cnt
                    ,SUM(IF(event IN ('continue_create_popup_click') AND clk_type = 2,1,0)) AS continue_recreate_cnt
            FROM    base
            GROUP BY os,cube(std_app_version)
        ) 
2、hailuo_dw.dws_hailuovedio_vip_gen_vedio_duration_di
--结果表 hailuo_dw.dws_hailuovedio_vip_gen_vedio_duration_di
------会员视频生成时间
WITH base AS 
(
    SELECT  t2.ymd
            ,`function`
            ,CAST(t2.distinct_id AS BIGINT) AS user_id
            ,CASE   WHEN DATEDIFF(CAST(CONCAT(SUBSTR(t2.ymd,1,4),'-',SUBSTR(t2.ymd,5,2),'-',SUBSTR(t2.ymd,7,2)) AS DATE),t3.activation_date) = 0 THEN 'new'
                    ELSE 'old'
            END AS is_new --新老用户
            ,CASE   WHEN t4.type = 1 THEN 'standard'
                    WHEN t4.type = 2 THEN 'unlimited'
                    WHEN t4.type = 5 THEN 'pro'
                    ELSE 'free'
            END AS `type` -- 用户等级
            ,trace_id
            ,t2.create_time
            ,input_trace_id
            ,result_time
            ,task_status
            ,event
    FROM    (
                SELECT                  -- NVL(NVL(GET_JSON_OBJECT(properties,'$.os'),GET_JSON_OBJECT(properties,'$.$os')),'') AS os,
                -- NVL(GET_JSON_OBJECT(properties,'$.device_platform'),'') AS device_platform,
                        GET_JSON_OBJECT(properties,'$.function') AS `function`
                        ,GET_JSON_OBJECT(properties,'$.trace_id') AS trace_id
                        ,GET_JSON_OBJECT(properties,'$.create_time') AS create_time
                        ,GET_JSON_OBJECT(properties,'$.input_trace_id') AS input_trace_id
                        ,GET_JSON_OBJECT(properties,'$.result_time') AS result_time
                        ,GET_JSON_OBJECT(properties,'$.task_status') AS task_status
                        ,NVL(BIGINT(distinct_id),'') AS distinct_id -----uid
                        ,properties
                        ,event
                        ,ymd
                FROM    talkie_ods.meerkat_event_tracking_rt
                WHERE   ymd = '${ymd}'
                AND     project = 'HailuoVideo'
                AND     distinct_id IS NOT NULL -- AND GET_JSON_OBJECT(properties,'$.client') IN  ('App') --- ('video-web','video-h5','web','h5','App')
                -- AND GET_JSON_OBJECT(properties,'$.lib') = 'server'
                -- AND GET_JSON_OBJECT(properties,'$.$os') IN ('Android') --- 'Android','iOS','HarmonyOS'
                AND     event IN ('user_input_track_click','model_output_track_data')
            ) t2
    LEFT JOIN   (
                    SELECT  user_id
                            ,MAX(ymd) AS ymd
                            ,MIN(activation_date) AS activation_date
                            ,MIN(NVL(country,'UNKNOWN')) AS country
                    FROM    hailuo_dw.dwd_hailuo_uid_activation_country_df
                    WHERE   ymd = MAX_PT('hailuo_dw.dwd_hailuo_uid_activation_country_df')
                    AND     project = 'video'
                    GROUP BY user_id
                ) t3
    ON      t2.distinct_id = t3.user_id -- AND     t2.ymd = t3.ymd
    LEFT JOIN   (
                    SELECT  *
                    FROM    (
                                SELECT  *
                                        ,GREATEST(TO_CHAR(FROM_UNIXTIME(BIGINT(create_time / 1000)),'yyyyMMdd'),TO_CHAR(FROM_UNIXTIME(BIGINT(update_time / 1000)),'yyyyMMdd')) AS create_date
                                        ,TO_CHAR(FROM_UNIXTIME(BIGINT(expire_time / 1000)),'yyyyMMdd') AS expire_date
                                        ,ROW_NUMBER() OVER (PARTITION BY user_id,ymd ORDER BY expire_time DESC,create_time DESC,update_time DESC ) AS rn
                                FROM    hailuo_ods.hailuo_privilege_user_privilege_df
                                WHERE   ymd = '${ymd}'
                                AND     type IN (1,2,5)
                            ) 
                    WHERE   rn = 1
                    AND     ymd BETWEEN create_date AND expire_date
                ) t4
    ON      t2.distinct_id = t4.user_id
)
INSERT OVERWRITE TABLE hailuo_dw.dws_hailuovedio_vip_gen_vedio_duration_di PARTITION (ymd = '${ymd}')
SELECT  IF(GROUPING(`function`) = 1,'ALL',`function`) AS `function`
        ,IF(GROUPING(is_new) = 1,'ALL',is_new) AS is_new
        ,IF(GROUPING(`type`) = 1,'ALL',`type`) AS `type`
        ,MAX(bigint(waiting_time)) AS max_waiting_time
        ,MIN(bigint(waiting_time)) AS min_waiting_time
        ,bigint(AVG(waiting_time)) AS avg_waiting_time
        ,bigint(PERCENTILE(bigint(waiting_time),0.3)) AS p30_avg_waiting_time
        ,bigint(PERCENTILE(bigint(waiting_time),0.5)) AS p50_avg_waiting_time
        ,bigint(PERCENTILE(bigint(waiting_time),0.7)) AS p70_avg_waiting_time
        ,bigint(PERCENTILE(bigint(waiting_time),0.9)) AS p90_avg_waiting_time
FROM    (
            SELECT  a.ymd
                    ,a.`function`
                    ,a.is_new
                    ,a.`type`
                    ,a.user_id
                    ,a.trace_id AS input_trace_id
                    ,b.trace_id
                    ,(b.result_time - a.create_time) / 1000 AS waiting_time
            FROM    (
                        SELECT  *
                        FROM    base
                        WHERE   event IN ('user_input_track_click')
                    ) a
            INNER JOIN  (
                            SELECT  *
                            FROM    base
                            WHERE   event IN ('model_output_track_data')
                        ) b
            ON      a.user_id = b.user_id
            AND     a.trace_id = b.input_trace_id
            AND     a.ymd = b.ymd
            WHERE   b.task_status = 'succeed'
        ) 
GROUP BY ymd
         ,CUBE(`function`,is_new,`type`)

3、hailuo_dw.dws_hailuovedio_quality_metric_di
--结果表 hailuo_dw.dws_hailuovedio_quality_metric_di
----性能指标
WITH base AS 
(
    SELECT  CASE    WHEN GET_JSON_OBJECT(properties,'$.client') = 'App' THEN 'App'
                    WHEN GET_JSON_OBJECT(properties,'$.client') IN ('video-web','web') THEN 'web'
                    WHEN GET_JSON_OBJECT(properties,'$.client') IN ('video-h5','h5') THEN 'h5'
                    ELSE 'OTHER'
            END AS client
            ,lib
            ,NVL(NVL(GET_JSON_OBJECT(properties,'$.os'),GET_JSON_OBJECT(properties,'$.$os')),'') AS os
            ,GET_JSON_OBJECT(properties, '$.$app_version') AS app_version
            ,hailuo_ods.HandleInspoVersionCode(get_json_object(properties, '$.$app_version')) AS std_app_version
            ,BIGINT(NVL(GET_JSON_OBJECT(properties,'$.login_status'),'0')) AS login_status 
            ,GET_JSON_OBJECT(properties,'$.first_launch') AS first_launch
            ,GET_JSON_OBJECT(properties,'$.duration') AS duration
            ,GET_JSON_OBJECT(properties,'$.application_init_duration') AS application_init_duration
            ,GET_JSON_OBJECT(properties,'$.start_duration') AS start_duration
            ,GET_JSON_OBJECT(properties,'$.result') AS result
            ,GET_JSON_OBJECT(properties,'$.stuck_count_per_second') AS stuck_count_per_second
            ,GET_JSON_OBJECT(properties,'$.stuck_duration_per_second') AS stuck_duration_per_second
            ,GET_JSON_OBJECT(properties,'$.stuck_count') AS stuck_count
            ,GET_JSON_OBJECT(properties,'$.fps') AS fps
            ,GET_JSON_OBJECT(properties,'$.refresh_rate') AS refresh_rate
            ,GET_JSON_OBJECT(properties,'$.lcp_duration') AS lcp_duration
            ,NVL(GET_JSON_OBJECT(properties,'$.page'),GET_JSON_OBJECT(properties,'$.page_name')) AS page
            ,NVL(BIGINT(GET_JSON_OBJECT(properties,'$.hailuo_user_id')),BIGINT(hailuo_ods.HaiLuoUidDecode(NVL(distinct_id,'')))) AS user_id
            ,BIGINT(GET_JSON_OBJECT(properties,'$.device_id')) AS device_id
            ,GET_JSON_OBJECT(properties,'$.login_id') AS login_id
            ,distinct_id
            ,properties
            ,event
            ,GET_JSON_OBJECT(properties,'$.execution_time') AS execution_time
    FROM    talkie_ods.meerkat_event_tracking_rt
    WHERE   ymd = '20250515'
    AND     project = 'HailuoVideo'
    AND     distinct_id IS NOT NULL
    AND     GET_JSON_OBJECT(properties,'$.client') IN ('video-web','video-h5','web','h5','App') 
    
    AND     event IN ('rd_app_launch','rd_scene_fps','rd_video_play_result','rd_page_open_result','init_h5_time','get_user_equity_start_time','get_app_config_start_time','init_model_time')
)
SELECT  os
        ,std_app_version
        ,refresh_rate
        ,quartile
        ,newu_start_time 
        ,oldu_start_time 
        ,vedio_start_time 
        ,stuck_count_per_second 
        ,stuck_duration_per_second 
        ,stuck_count 
        ,choiceness_list_fps 
        ,entity_detail_page_fps 
        ,image_create_page_fps 
        ,entity_detail_page_lcp 
        ,image_create_page_lcp 
        ,create_page_init_time 
        ,get_user_equity_cost_time 
        ,get_app_config_cost_time 
        ,init_model_cost_time 
FROM    (
            SELECT  os
                    ,IF(GROUPING(std_app_version) = 1,'ALL',std_app_version) AS std_app_version
                    ,IF(GROUPING(refresh_rate) = 1,'ALL',refresh_rate) AS refresh_rate
                    ,'p30' AS quartile
                    ,PERCENTILE(IF(event = 'rd_app_launch' AND first_launch = 'true' 
                                AND bigint(duration / 1000) >0 AND bigint(duration / 1000) < 10
                                ,bigint(duration / 1000),NULL),0.3) AS `newu_start_time`
                    ,PERCENTILE(IF(event = 'rd_app_launch' AND first_launch = 'false'
                                AND bigint(duration / 1000) >0 AND bigint(duration / 1000) < 10
                                ,bigint(duration / 1000),NULL),0.3) AS `oldu_start_time`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(start_duration / 1000),NULL),0.3) AS `vedio_start_time`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(stuck_count_per_second),NULL),0.3) AS `stuck_count_per_second`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(stuck_duration_per_second / 1000),NULL),0.3) AS `stuck_duration_per_second`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(stuck_count),NULL),0.3) AS `stuck_count`
                    ,PERCENTILE(IF(event = 'rd_scene_fps' AND page = 'video_home_page',bigint(fps),NULL),0.7) AS `choiceness_list_fps`
                    ,PERCENTILE(
                               IF(event = 'rd_scene_fps' AND page IN ('entity_detail_page','video_detail_page'),bigint(fps),NULL)
                    ,0.7) AS `entity_detail_page_fps`
                    ,PERCENTILE(
                               IF(event = 'rd_scene_fps' AND page IN ('video_create_page ','image_create_page'),bigint(fps),NULL)
                    ,0.7) AS `image_create_page_fps`
                    ,PERCENTILE(
                               IF(event = 'rd_page_open_result' AND page IN ('entity_detail_page','video_detail_page')
                                AND bigint(lcp_duration / 1000) >0 AND bigint(lcp_duration / 1000) < 10
                                ,bigint(lcp_duration / 1000),NULL)
                    ,0.3) AS `entity_detail_page_lcp`
                    ,PERCENTILE(
                               IF(event = 'rd_page_open_result' AND page IN ('video_create_page ','image_create_page')
                                AND bigint(lcp_duration / 1000) >0 AND bigint(lcp_duration / 1000) < 10
                                ,bigint(lcp_duration / 1000),NULL)
                    ,0.3) AS `image_create_page_lcp`
                    ,PERCENTILE(
                               IF(event = 'init_h5_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.3) AS `create_page_init_time`
                    ,PERCENTILE(
                               IF(event = 'get_user_equity_start_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.3) AS `get_user_equity_cost_time`
                    ,PERCENTILE(
                               IF(event = 'get_app_config_start_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.3) AS `get_app_config_cost_time`
                    ,PERCENTILE(
                               IF(event = 'init_model_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.3) AS `init_model_cost_time`
            FROM    base
            GROUP BY os
                     ,CUBE(std_app_version)
                     ,CUBE(refresh_rate)

            UNION ALL

            SELECT  os
                    ,IF(GROUPING(std_app_version) = 1,'ALL',std_app_version) AS std_app_version
                    ,IF(GROUPING(refresh_rate) = 1,'ALL',refresh_rate) AS refresh_rate
                    ,'p50' AS quartile
                    ,PERCENTILE(IF(event = 'rd_app_launch' AND first_launch = 'true'
                                AND bigint(duration / 1000) >0 AND bigint(duration / 1000) < 10
                                ,bigint(duration / 1000),NULL),0.5) AS `newu_start_time`
                    ,PERCENTILE(IF(event = 'rd_app_launch' AND first_launch = 'false'
                                AND bigint(duration / 1000) >0 AND bigint(duration / 1000) < 10
                                ,bigint(duration / 1000),NULL),0.5) AS `oldu_start_time`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(start_duration / 1000),NULL),0.5) AS `vedio_start_time`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(stuck_count_per_second),NULL),0.5) AS `stuck_count_per_second`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(stuck_duration_per_second / 1000),NULL),0.5) AS `stuck_duration_per_second`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(stuck_count),NULL),0.5) AS `stuck_count`
                    ,PERCENTILE(IF(event = 'rd_scene_fps' AND page = 'video_home_page',bigint(fps),NULL),0.5) AS `choiceness_list_fps`
                    ,PERCENTILE(
                               IF(event = 'rd_scene_fps' AND page IN ('entity_detail_page','video_detail_page'),bigint(fps),NULL)
                    ,0.5) AS `entity_detail_page_fps`
                    ,PERCENTILE(
                               IF(event = 'rd_scene_fps' AND page IN ('video_create_page ','image_create_page'),bigint(fps),NULL)
                    ,0.5) AS `image_create_page_fps`
                    ,PERCENTILE(
                               IF(event = 'rd_page_open_result' AND page IN ('entity_detail_page','video_detail_page')
                                AND bigint(lcp_duration / 1000) >0 AND bigint(lcp_duration / 1000) < 10
                                ,bigint(lcp_duration / 1000),NULL)
                    ,0.5) AS `entity_detail_page_lcp`
                    ,PERCENTILE(
                               IF(event = 'rd_page_open_result' AND page IN ('video_create_page ','image_create_page')
                                AND bigint(lcp_duration / 1000) >0 AND bigint(lcp_duration / 1000) < 10
                                ,bigint(lcp_duration / 1000),NULL)
                    ,0.5) AS `image_create_page_lcp`
                    ,PERCENTILE(
                               IF(event = 'init_h5_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.5) AS `create_page_init_time`
                    ,PERCENTILE(
                               IF(event = 'get_user_equity_start_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.5) AS `get_user_equity_cost_time`
                    ,PERCENTILE(
                               IF(event = 'get_app_config_start_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.5) AS `get_app_config_cost_time`
                    ,PERCENTILE(
                               IF(event = 'init_model_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.5) AS `init_model_cost_time`
            FROM    base
            GROUP BY os
                     ,CUBE(std_app_version)
                     ,CUBE(refresh_rate)

            UNION ALL

            SELECT  os
                    ,IF(GROUPING(std_app_version) = 1,'ALL',std_app_version) AS std_app_version
                    ,IF(GROUPING(refresh_rate) = 1,'ALL',refresh_rate) AS refresh_rate
                    ,'p70' AS quartile
                    ,PERCENTILE(IF(event = 'rd_app_launch' AND first_launch = 'true'
                                AND bigint(duration / 1000) > 0 AND bigint(duration / 1000) < 10
                                ,bigint(duration / 1000),NULL),0.7) AS `newu_start_time`
                    ,PERCENTILE(IF(event = 'rd_app_launch' AND first_launch = 'false'
                                AND bigint(duration / 1000) >0 AND bigint(duration / 1000) < 10
                                ,bigint(duration / 1000),NULL),0.7) AS `oldu_start_time`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(start_duration / 1000),NULL),0.7) AS `vedio_start_time`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(stuck_count_per_second),NULL),0.7) AS `stuck_count_per_second`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(stuck_duration_per_second / 1000),NULL),0.7) AS `stuck_duration_per_second`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(stuck_count),NULL),0.7) AS `stuck_count`
                    ,PERCENTILE(IF(event = 'rd_scene_fps' AND page = 'video_home_page',bigint(fps),NULL),0.7) AS `choiceness_list_fps`
                    ,PERCENTILE(
                               IF(event = 'rd_scene_fps' AND page IN ('entity_detail_page','video_detail_page'),bigint(fps),NULL)
                    ,0.3) AS `entity_detail_page_fps`
                    ,PERCENTILE(
                               IF(event = 'rd_scene_fps' AND page IN ('video_create_page ','image_create_page'),bigint(fps),NULL)
                    ,0.3) AS `image_create_page_fps`
                    ,PERCENTILE(
                               IF(event = 'rd_page_open_result' AND page IN ('entity_detail_page','video_detail_page')
                                AND bigint(lcp_duration / 1000) >0 AND bigint(lcp_duration / 1000) < 10
                                ,bigint(lcp_duration / 1000),NULL)
                    ,0.7) AS `entity_detail_page_lcp`
                    ,PERCENTILE(
                               IF(event = 'rd_page_open_result' AND page IN ('video_create_page ','image_create_page')
                                AND bigint(lcp_duration / 1000) >0 AND bigint(lcp_duration / 1000) < 10
                                ,bigint(lcp_duration / 1000),NULL)
                    ,0.7) AS `image_create_page_lcp`
                    ,PERCENTILE(
                               IF(event = 'init_h5_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.7) AS `create_page_init_time`
                    ,PERCENTILE(
                               IF(event = 'get_user_equity_start_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.7) AS `get_user_equity_cost_time`
                    ,PERCENTILE(
                               IF(event = 'get_app_config_start_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.7) AS `get_app_config_cost_time`
                    ,PERCENTILE(
                               IF(event = 'init_model_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.7) AS `init_model_cost_time`
            FROM    base
            GROUP BY os
                     ,CUBE(std_app_version)
                     ,CUBE(refresh_rate)

            UNION ALL

            SELECT  os
                    ,IF(GROUPING(std_app_version) = 1,'ALL',std_app_version) AS std_app_version
                    ,IF(GROUPING(refresh_rate) = 1,'ALL',refresh_rate) AS refresh_rate
                    ,'p90' AS quartile
                    ,PERCENTILE(IF(event = 'rd_app_launch' AND first_launch = 'true'
                                AND bigint(duration / 1000) >0 AND bigint(duration / 1000) < 10
                                ,bigint(duration / 1000),NULL),0.9) AS `newu_start_time`
                    ,PERCENTILE(IF(event = 'rd_app_launch' AND first_launch = 'false'
                                AND bigint(duration / 1000) >0 AND bigint(duration / 1000) < 10
                                ,bigint(duration / 1000),NULL),0.9) AS `oldu_start_time`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(start_duration / 1000),NULL),0.9) AS `vedio_start_time`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(stuck_count_per_second),NULL),0.9) AS `stuck_count_per_second`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(stuck_duration_per_second / 1000),NULL),0.9) AS `stuck_duration_per_second`
                    ,PERCENTILE(IF(event = 'rd_video_play_result',bigint(stuck_count),NULL),0.9) AS `stuck_count`
                    ,PERCENTILE(IF(event = 'rd_scene_fps' AND page = 'video_home_page',bigint(fps),NULL),0.9) AS `choiceness_list_fps`
                    ,PERCENTILE(
                               IF(event = 'rd_scene_fps' AND page IN ('entity_detail_page','video_detail_page'),bigint(fps),NULL)
                    ,0.1) AS `entity_detail_page_fps`
                    ,PERCENTILE(
                               IF(event = 'rd_scene_fps' AND page IN ('video_create_page ','image_create_page'),bigint(fps),NULL)
                    ,0.1) AS `image_create_page_fps`
                    ,PERCENTILE(
                               IF(event = 'rd_page_open_result' AND page IN ('entity_detail_page','video_detail_page')
                                AND bigint(lcp_duration / 1000) >0 AND bigint(lcp_duration / 1000) < 10
                                ,bigint(lcp_duration / 1000),NULL)
                    ,0.9) AS `entity_detail_page_lcp`
                    ,PERCENTILE(
                               IF(event = 'rd_page_open_result' AND page IN ('video_create_page ','image_create_page')
                                AND bigint(lcp_duration / 1000) >0 AND bigint(lcp_duration / 1000) < 10
                                ,bigint(lcp_duration / 1000),NULL)
                    ,0.9) AS `image_create_page_lcp`
                    ,PERCENTILE(
                               IF(event = 'init_h5_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.9) AS `create_page_init_time`
                    ,PERCENTILE(
                               IF(event = 'get_user_equity_start_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.9) AS `get_user_equity_cost_time`
                    ,PERCENTILE(
                               IF(event = 'get_app_config_start_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.9) AS `get_app_config_cost_time`
                    ,PERCENTILE(
                               IF(event = 'init_model_time' AND page IN ('video_create_page ','image_create_page'),bigint(execution_time / 1000),NULL)
                    ,0.9) AS `init_model_cost_time`
            FROM    base
            GROUP BY os
                     ,CUBE(std_app_version)
                     ,CUBE(refresh_rate)
        );


4、hailuo_dw.dws_hailuovedio_err_msg_metric_di
-----失败原因等枚举值分布情况
WITH base AS 
(
    SELECT  CASE    WHEN GET_JSON_OBJECT(properties,'$.client') = 'App' THEN 'App'
                    WHEN GET_JSON_OBJECT(properties,'$.client') IN ('video-web','web') THEN 'web'
                    WHEN GET_JSON_OBJECT(properties,'$.client') IN ('video-h5','h5') THEN 'h5'
                    ELSE 'OTHER'
            END AS client
            ,lib
            ,NVL(NVL(GET_JSON_OBJECT(properties,'$.os'),GET_JSON_OBJECT(properties,'$.$os')),'') AS os
            ,GET_JSON_OBJECT(properties, '$.$app_version') AS app_version
            ,CAST(
            CONCAT(
                LPAD(COALESCE(split(GET_JSON_OBJECT(properties, '$.$app_version'), '\\.')[0], '0'), 1, '0'), 
                LPAD(COALESCE(split(GET_JSON_OBJECT(properties, '$.$app_version'), '\\.')[1], '0'), 2, '0'), 
                LPAD(COALESCE(split(GET_JSON_OBJECT(properties, '$.$app_version'), '\\.')[2], '0'), 3, '0')  
                ) AS BIGINT
            ) AS std_app_version
            ,GET_JSON_OBJECT(properties,'$.result_type') AS result_type
            ,GET_JSON_OBJECT(properties,'$.login_type') AS login_type
            ,GET_JSON_OBJECT(properties,'$.fail_reason') AS fail_reason
            ,GET_JSON_OBJECT(properties,'$.status') AS status
            ,GET_JSON_OBJECT(properties,'$.error_msg') AS error_msg
            ,GET_JSON_OBJECT(properties,'$.error_message') AS error_message
            ,GET_JSON_OBJECT(properties,'$.error_code') AS error_code
            ,NVL(GET_JSON_OBJECT(properties,'$.page'),GET_JSON_OBJECT(properties,'$.page_name')) AS page
            ,NVL(GET_JSON_OBJECT(properties,'$.source_page'),GET_JSON_OBJECT(properties,'$.source')) AS source_page
            ,NVL(BIGINT(GET_JSON_OBJECT(properties,'$.hailuo_user_id')),BIGINT(hailuo_ods.HaiLuoUidDecode(NVL(distinct_id,'')))) AS user_id
            ,BIGINT(GET_JSON_OBJECT(properties,'$.device_id')) AS device_id
            ,GET_JSON_OBJECT(properties,'$.login_id') AS login_id
            ,distinct_id
            ,properties
            ,event
            ,ymd
    FROM    talkie_ods.meerkat_event_tracking_rt
    WHERE   ymd ='${ymd}'
    AND     project = 'HailuoVideo'
    AND     distinct_id IS NOT NULL
    AND     GET_JSON_OBJECT(properties,'$.client') IN ('App') --- ('video-web','video-h5','web','h5','App')
    -- AND GET_JSON_OBJECT(properties,'$.lib') = 'server'
    -- AND GET_JSON_OBJECT(properties,'$.$os') IN ('Android') --- 'Android','iOS','HarmonyOS'
    AND     (
                event IN ('login_result','payment_result','upload_image_result','character_detection_result')
                OR      (
                            event = 'page_view'
                            AND     NVL(GET_JSON_OBJECT(properties,'$.page'),GET_JSON_OBJECT(properties,'$.page_name')) IN ('subscription_page','credits_page')
                )
    )
)
INSERT OVERWRITE TABLE hailuo_dw.dws_hailuovedio_err_msg_metric_di PARTITION (ymd = '${ymd}')
SELECT  IF(GROUPING(os) = 1,'ALL',os) AS os
        ,IF(GROUPING(std_app_version) = 1,'ALL',std_app_version) AS std_app_version
        ,indicator
        ,`type`
        ,SUM(cnt) AS cnt
FROM    (
            SELECT  os
                    ,std_app_version
                    ,'登录方式的分布' AS indicator
                    ,login_type AS `type`
                    ,COUNT(1) AS cnt
            FROM    base
            WHERE   event = 'login_result'
            AND     result_type = 1
            GROUP BY os
                     ,std_app_version
                     ,login_type
            UNION ALL
            SELECT  os
                    ,std_app_version
                    ,'登录失败原因的分布' AS indicator
                    ,fail_reason AS `type`
                    ,COUNT(1) AS cnt
            FROM    base
            WHERE   event = 'login_result'
            AND     result_type <> 1
            GROUP BY os
                     ,std_app_version
                     ,fail_reason
            UNION ALL
            SELECT  os
                    ,std_app_version
                    ,'购买失败原因分布' AS indicator
                    ,error_msg AS `type`
                    ,COUNT(1) AS cnt
            FROM    base
            WHERE   event = 'payment_result'
            AND     status <> 0
            GROUP BY os
                     ,std_app_version
                     ,error_msg
            UNION ALL
            SELECT  os
                    ,std_app_version
                    ,'支付入口分布' AS indicator
                    ,source_page AS `type`
                    ,COUNT(1) AS cnt
            FROM    base
            WHERE   event = 'page_view'
            AND     page IN ('subscription_page','credits_page')
            GROUP BY os
                     ,std_app_version
                     ,source_page
            UNION ALL
            SELECT  os
                    ,std_app_version
                    ,'图片上传失败原因分布' AS indicator
                    ,error_message AS `type`
                    ,COUNT(1) AS cnt
            FROM    base
            WHERE   event = 'upload_image_result'
            AND     result_type <> 1
            GROUP BY os
                     ,std_app_version
                     ,error_message
            UNION ALL
            SELECT  os
                    ,std_app_version
                    ,'主体检测失败原因分布' AS indicator
                    ,error_message AS `type`
                    ,COUNT(1) AS cnt
            FROM    base
            WHERE   event = 'character_detection_result'
            AND     result_type <> 1
            GROUP BY os
                     ,std_app_version
                     ,error_message
        ) 
GROUP BY CUBE(os)
         ,CUBE(std_app_version)
         ,indicator
         ,type

## event属性及类型汇总

client: string
lib: string
os: string
app_version: string
std_app_version: string
login_status: number
popup_type: string
result_type: number
login_type: string
fail_reason: string
error_code: string
status: string
product_type: string
entity_type: string
function: string
trace_id: string
create_time: number
input_trace_id: string
result_time: number
clk_type: string
page: string
page_name: string
source_page: string
source: string
user_id: number
device_id: number
login_id: string
distinct_id: string
properties: string
event: string
ymd: string
first_launch: string
duration: number
application_init_duration: number
start_duration: number
result: string
stuck_count_per_second: number
stuck_duration_per_second: number
stuck_count: number
fps: number
refresh_rate: number
lcp_duration: number
execution_time: number
error_msg: string
error_message: string
country: string
task_status: string
